<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chit Chat - Static P2P</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            @apply bg-gray-100 text-gray-900 min-h-screen flex items-center justify-center p-4;
        }
        /* Custom scrollbar for chat messages */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* Dark mode styles */
        body.dark {
            @apply bg-gray-900 text-gray-100;
        }
        body.dark #app-container {
            @apply bg-gray-800;
        }
        body.dark .border-gray-200 {
            @apply border-gray-700;
        }
        body.dark .bg-white {
            @apply bg-gray-800;
        }
        body.dark .text-gray-900 {
            @apply text-gray-100;
        }
        body.dark .text-gray-700 {
            @apply text-gray-300;
        }
        body.dark .text-gray-500 {
            @apply text-gray-400;
        }
        body.dark .bg-gray-100 {
            @apply bg-gray-700;
        }
        body.dark .bg-gray-50 {
            @apply bg-gray-900;
        }
        body.dark .bg-gray-200 {
            @apply bg-gray-700;
        }
        body.dark .border-gray-300 {
            @apply border-gray-600;
        }
        body.dark .bg-blue-50 {
            @apply bg-blue-900;
        }
        body.dark .border-blue-200 {
            @apply border-blue-700;
        }
        body.dark .text-blue-800 {
            @apply text-blue-200;
        }
        body.dark .text-blue-600 {
            @apply text-blue-400;
        }
        body.dark .text-blue-500 {
            @apply text-blue-400;
        }
        body.dark .bg-purple-300 {
            @apply bg-purple-700;
        }
        body.dark .bg-gray-300 {
            @apply bg-gray-600;
        }
        body.dark .hover\:bg-gray-100:hover {
            @apply hover:bg-gray-700;
        }
        body.dark .bg-blue-100 {
            @apply bg-blue-700;
        }
        body.dark .text-blue-200 {
            @apply text-blue-300;
        }
        body.dark .hover\:bg-gray-300:hover {
            @apply hover:bg-gray-600;
        }
        /* Fix for timestamp blur/overlap */
        .message-bubble {
            position: relative; /* Ensure positioning context for timestamp */
            padding-bottom: 1.5rem; /* Make space for timestamp */
        }
        .message-timestamp {
            position: absolute;
            bottom: 0.25rem; /* Adjust as needed */
            font-size: 0.75rem; /* text-xs */
            opacity: 0.8; /* Slightly less prominent */
            white-space: nowrap; /* Prevent timestamp from wrapping */
        }
        .message-bubble.bg-blue-500 .message-timestamp {
            right: 0.5rem;
            color: rgba(255, 255, 255, 0.7); /* Lighter color for dark background */
        }
        .message-bubble.bg-gray-200 .message-timestamp {
            left: 0.5rem;
            color: rgba(75, 85, 99, 0.7); /* Darker color for light background */
        }
        body.dark .message-bubble.bg-gray-200 .message-timestamp {
            color: rgba(209, 213, 219, 0.7); /* Lighter color for dark background in dark mode */
        }
    </style>
</head>
<body class="light">
    <div id="app-container" class="flex flex-col md:flex-row h-[90vh] w-full max-w-6xl bg-white rounded-xl shadow-2xl overflow-hidden">

        <div class="w-full md:w-80 bg-white border-r border-gray-200 flex flex-col p-4">
            <div class="flex items-center justify-between pb-4 border-b border-gray-200 mb-4">
                <h2 class="text-2xl font-bold text-blue-600">Chit Chat</h2>
                <div class="flex space-x-2">
                    <button id="create-group-btn" class="p-2 rounded-full bg-green-500 text-white hover:bg-green-600 transition-colors duration-200" title="New Group">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" class="lucide lucide-plus"><path d="M12 5v14"/><path d="M5 12h14"/></svg>
                    </button>
                    <button id="theme-toggle-btn" class="p-2 rounded-full bg-gray-200 text-gray-700 hover:bg-gray-300 transition-colors duration-200" title="Toggle Theme">
                        🌙
                    </button>
                </div>
            </div>

            <div class="mb-4">
                <div class="relative">
                    <input type="text" id="search-input" placeholder="Search users or groups..." class="w-full p-2 pl-10 rounded-lg bg-gray-100 border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-400">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" class="lucide lucide-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-500"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
                </div>
            </div>

            <div id="my-id-section" class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4 text-sm text-blue-800">
                <strong>Your ID:</strong> <span id="my-peer-id" class="font-semibold cursor-pointer select-all">Loading...</span>
                <p class="text-xs text-blue-600 mt-1">Click ID to copy. Share this to connect!</p>
            </div>

            <div class="flex-1 overflow-y-auto custom-scrollbar">
                <div class="flex items-center justify-between px-2 pt-2 pb-2">
                    <h3 class="text-lg font-semibold text-gray-700">Direct Messages</h3>
                    <button id="add-friend-sidebar-btn" class="p-1 rounded-full bg-blue-500 text-white hover:bg-blue-600 transition-colors duration-200" title="Add Friend">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" class="lucide lucide-plus"><path d="M12 5v14"/><path d="M5 12h14"/></svg>
                    </button>
                </div>
                <div id="direct-messages-list">
                    <p class="text-sm text-gray-500 px-2" id="no-direct-chats">No direct chats yet. Click '+' to add a friend!</p>
                </div>

                <h3 class="text-lg font-semibold px-2 pt-4 pb-2 text-gray-700">Groups</h3>
                <div id="groups-list">
                    <p class="text-sm text-gray-500 px-2" id="no-groups">No groups created yet.</p>
                </div>
            </div>
        </div>

        <div class="flex-1 flex flex-col bg-gray-50 border-l border-gray-200">
            <div id="chat-header" class="bg-white p-4 border-b border-gray-200 shadow-sm flex items-center justify-between">
                <h3 class="text-xl font-semibold text-gray-800" id="current-chat-name">Select a chat</h3>
                </div>

            <div id="messages-display" class="flex-1 overflow-y-auto p-4 space-y-3 custom-scrollbar">
                <div class="text-center text-gray-500 text-sm mt-4" id="initial-chat-message">
                    Start by connecting to a friend or creating a group!
                </div>
            </div>

            <div id="chat-input-area" class="p-4 bg-white border-t border-gray-200 flex items-center space-x-3">
                <input type="text" id="message-input" placeholder="Type a message..." class="flex-1 p-3 rounded-lg border border-gray-300 bg-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-400">
                <button id="send-message-btn" class="p-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors duration-200 shadow-md">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" class="lucide lucide-send"><path d="m22 2-7 20-4-9-9-4 20-7Z"/><path d="M22 2 11 13"/></svg>
                </button>
            </div>
        </div>

        <div id="info-sidebar" class="w-full md:w-80 bg-white border-l border-gray-200 flex-col p-4 hidden">
            <div class="pb-4 border-b border-gray-200 mb-4">
                <h3 class="text-xl font-semibold text-gray-800" id="info-sidebar-title">Chat Info</h3>
            </div>
            <div id="info-sidebar-content" class="flex-1 overflow-y-auto custom-scrollbar">
                </div>
        </div>

    </div>

    <div id="add-friend-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden p-4">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
            <h2 class="text-2xl font-bold mb-6 text-gray-800">Add a Friend</h2>
            <div class="mb-4">
                <label for="friend-id-input" class="block text-gray-700 text-sm font-semibold mb-2">Friend's Peer ID</label>
                <input type="text" id="friend-id-input" class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-100 focus:ring-2 focus:ring-blue-400" placeholder="Enter friend's full Peer ID">
            </div>
            <div class="mb-4">
                <label for="friend-name-input" class="block text-gray-700 text-sm font-semibold mb-2">Friend's Display Name (Optional)</label>
                <input type="text" id="friend-name-input" class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-100 focus:ring-2 focus:ring-blue-400" placeholder="e.g., John Doe">
            </div>
            <p id="add-friend-status" class="text-sm text-gray-600 mb-4"></p>
            <div class="flex justify-end space-x-4">
                <button id="cancel-add-friend-btn" class="px-5 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400 transition-colors duration-200">
                    Cancel
                </button>
                <button id="confirm-add-friend-btn" class="px-5 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors duration-200">
                    Connect
                </button>
            </div>
        </div>
    </div>

    <div id="create-group-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden p-4">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
            <h2 class="text-2xl font-bold mb-6 text-gray-800">Create New Group</h2>
            <div class="mb-4">
                <label for="group-name-input" class="block text-gray-700 text-sm font-semibold mb-2">Group Name</label>
                <input type="text" id="group-name-input" class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-100 focus:ring-2 focus:ring-blue-400" placeholder="Enter group name">
            </div>
            <div class="mb-6">
                <label class="block text-gray-700 text-sm font-semibold mb-2">Select Members (by ID)</label>
                <div class="flex items-center space-x-2 mb-2">
                    <input type="text" id="add-member-id-input" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg bg-gray-100 focus:ring-2 focus:ring-blue-400" placeholder="Enter member's Peer ID">
                    <button id="add-member-btn" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors duration-200">Add</button>
                </div>
                <ul id="selected-members-list" class="h-40 overflow-y-auto border border-gray-300 rounded-lg p-2 bg-gray-100">
                    </ul>
            </div>
            <p id="create-group-status" class="text-sm text-gray-600 mb-4"></p>
            <div class="flex justify-end space-x-4">
                <button id="cancel-create-group-btn" class="px-5 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400 transition-colors duration-200">
                    Cancel
                </button>
                <button id="confirm-create-group-btn" class="px-5 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors duration-200">
                    Create Group
                </button>
            </div>
        </div>
    </div>


    <script>
        // --- DOM Elements ---
        const myPeerIdSpan = document.getElementById('my-peer-id');
        const directMessagesList = document.getElementById('direct-messages-list');
        const groupsList = document.getElementById('groups-list');
        const noDirectChatsMsg = document.getElementById('no-direct-chats');
        const noGroupsMsg = document.getElementById('no-groups');
        const chatHeader = document.getElementById('chat-header');
        const currentChatName = document.getElementById('current-chat-name');
        const messagesDisplay = document.getElementById('messages-display');
        const initialChatMessage = document.getElementById('initial-chat-message');
        const messageInput = document.getElementById('message-input');
        const sendMessageBtn = document.getElementById('send-message-btn');
        const createGroupBtn = document.getElementById('create-group-btn');
        const themeToggleBtn = document.getElementById('theme-toggle-btn');
        const searchInput = document.getElementById('search-input');
        const addFriendSidebarBtn = document.getElementById('add-friend-sidebar-btn'); // New button reference

        // Modals
        const addFriendModal = document.getElementById('add-friend-modal');
        const friendIdInput = document.getElementById('friend-id-input');
        const friendNameInput = document.getElementById('friend-name-input'); // New input for friend name
        const addFriendStatus = document.getElementById('add-friend-status');
        const cancelAddFriendBtn = document.getElementById('cancel-add-friend-btn');
        const confirmAddFriendBtn = document.getElementById('confirm-add-friend-btn');

        const createGroupModal = document.getElementById('create-group-modal');
        const groupNameInput = document.getElementById('group-name-input');
        const addMemberIdInput = document.getElementById('add-member-id-input');
        const addMemberBtn = document.getElementById('add-member-btn');
        const selectedMembersList = document.getElementById('selected-members-list');
        const createGroupStatus = document.getElementById('create-group-status');
        const cancelCreateGroupBtn = document.getElementById('cancel-create-group-btn');
        const confirmCreateGroupBtn = document.getElementById('confirm-create-group-btn');

        // --- PeerJS Setup ---
        let peer = null;
        let myId = null;
        let activeConnection = null; // Stores the current DataConnection object
        let activeChat = { type: null, id: null, name: null }; // { type: 'user' | 'group', id: 'peerId' | 'groupId', name: 'Chat Name' }

        // Store connections for direct messages (key: peerId, value: DataConnection)
        const directConnections = new Map();
        // Store group members (key: groupId, value: Set<peerId>)
        const groupMembers = new Map();
        // Store group names (key: groupId, value: groupName)
        const groupNames = new Map();

        // --- Local Storage Keys ---
        const LS_FRIENDS_KEY = 'chitchat_friends';
        const LS_GROUPS_KEY = 'chitchat_groups';
        const LS_THEME_KEY = 'chitchat_theme';

        // --- Data Structures from Local Storage ---
        let friends = JSON.parse(localStorage.getItem(LS_FRIENDS_KEY) || '[]'); // Array of { id: peerId, name: 'Friend Name' (optional) }
        let groups = JSON.parse(localStorage.getItem(LS_GROUPS_KEY) || '[]'); // Array of { id: groupId, name: groupName, members: [peerId1, peerId2] }

        // --- Utility Functions ---
        function saveFriends() {
            localStorage.setItem(LS_FRIENDS_KEY, JSON.stringify(friends));
        }

        function saveGroups() {
            localStorage.setItem(LS_GROUPS_KEY, JSON.stringify(groups));
        }

        function isImageUrl(url) {
            return (url.match(/\.(jpeg|jpg|gif|png|webp)$/) != null);
        }

        function isVideoUrl(url) {
            return (url.match(/\.(mp4|webm|ogg)$/) != null);
        }

        function addMessageToDisplay(message, senderId, isMe = false, chatType = 'user') {
            const messageElement = document.createElement('div');
            messageElement.className = `flex mb-2 ${isMe ? 'justify-end' : 'justify-start'}`;

            const bubble = document.createElement('div');
            bubble.className = `message-bubble max-w-[70%] p-3 rounded-lg shadow-sm relative ${
                isMe ? 'bg-blue-500 text-white rounded-br-none' : 'bg-gray-200 text-gray-900 rounded-bl-none'
            }`;

            if (chatType === 'group' && !isMe) {
                const senderName = getFriendName(senderId) || senderId.substring(0, 5); // Display short ID if no name
                const senderSpan = document.createElement('p');
                senderSpan.className = 'text-xs font-semibold text-gray-600 mb-1';
                bubble.classList.add('dark:text-gray-300'); // Dark mode adjustment
                senderSpan.textContent = senderName;
                bubble.appendChild(senderSpan);
            }

            // Handle URLs for images/videos/links
            const urlRegex = /(https?:\/\/[^\s]+)/g;
            if (urlRegex.test(message)) {
                const parts = message.split(urlRegex);
                parts.forEach(part => {
                    if (urlRegex.test(part)) {
                        if (isImageUrl(part)) {
                            const img = document.createElement('img');
                            img.src = part;
                            img.alt = 'Image';
                            img.className = 'max-w-full h-auto rounded-md my-1';
                            img.onerror = () => {
                                const link = document.createElement('a');
                                link.href = part;
                                link.textContent = part;
                                link.target = '_blank';
                                link.className = 'text-blue-300 underline';
                                bubble.appendChild(link);
                            };
                            bubble.appendChild(img);
                        } else if (isVideoUrl(part)) {
                            const video = document.createElement('video');
                            video.src = part;
                            video.controls = true;
                            video.className = 'max-w-full h-auto rounded-md my-1';
                            video.onerror = () => {
                                const link = document.createElement('a');
                                link.href = part;
                                link.textContent = part;
                                link.target = '_blank';
                                link.className = 'text-blue-300 underline';
                                bubble.appendChild(link);
                            };
                            bubble.appendChild(video);
                        } else {
                            const link = document.createElement('a');
                            link.href = part;
                            link.textContent = part;
                            link.target = '_blank';
                            link.className = 'text-blue-300 underline';
                            bubble.appendChild(link);
                        }
                    } else if (part) {
                        const textNode = document.createTextNode(part);
                        bubble.appendChild(textNode);
                    }
                });
            } else {
                const textSpan = document.createElement('p');
                textSpan.className = 'text-sm';
                textSpan.textContent = message;
                bubble.appendChild(textSpan);
            }

            const timestampSpan = document.createElement('span');
            timestampSpan.className = `message-timestamp`; // Apply new class for styling
            timestampSpan.textContent = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            bubble.appendChild(timestampSpan);

            messageElement.appendChild(bubble);
            messagesDisplay.appendChild(messageElement);
            messagesDisplay.scrollTop = messagesDisplay.scrollHeight; // Scroll to bottom
            initialChatMessage.classList.add('hidden'); // Hide initial message
        }

        function getFriendName(peerId) {
            const friend = friends.find(f => f.id === peerId);
            return friend ? friend.name : null;
        }

        function updateFriendListUI() {
            directMessagesList.innerHTML = '';
            if (friends.length === 0) {
                noDirectChatsMsg.classList.remove('hidden');
            } else {
                noDirectChatsMsg.classList.add('hidden');
                friends.forEach(friend => {
                    const friendElement = document.createElement('div');
                    friendElement.className = `flex items-center p-3 cursor-pointer hover:bg-gray-100 rounded-lg transition-colors duration-200 ${activeChat.type === 'user' && activeChat.id === friend.id ? 'bg-blue-100' : ''}`;
                    friendElement.innerHTML = `
                        <div class="w-10 h-10 rounded-full bg-gray-300 flex items-center justify-center text-white font-bold mr-3">
                            ${(friend.name || friend.id)[0].toUpperCase()}
                        </div>
                        <div>
                            <p class="font-semibold">${friend.name || friend.id.substring(0, 5)}</p>
                            <p class="text-sm text-gray-500 truncate">Last message preview...</p>
                        </div>
                    `;
                    friendElement.onclick = () => selectChat({ type: 'user', id: friend.id, name: friend.name || friend.id.substring(0, 5) });
                    directMessagesList.appendChild(friendElement);
                });
            }
        }

        function updateGroupListUI() {
            groupsList.innerHTML = '';
            if (groups.length === 0) {
                noGroupsMsg.classList.remove('hidden');
            } else {
                noGroupsMsg.classList.add('hidden');
                groups.forEach(group => {
                    const groupElement = document.createElement('div');
                    groupElement.className = `flex items-center p-3 cursor-pointer hover:bg-gray-100 rounded-lg transition-colors duration-200 ${activeChat.type === 'group' && activeChat.id === group.id ? 'bg-blue-100' : ''}`;
                    groupElement.innerHTML = `
                        <div class="w-10 h-10 rounded-full bg-purple-300 flex items-center justify-center text-white font-bold mr-3">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" class="lucide lucide-users"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87L16 14"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                        </div>
                        <div>
                            <p class="font-semibold">${group.name}</p>
                            <p class="text-sm text-gray-500 truncate">Members: ${group.members.length}</p>
                        </div>
                    `;
                    groupElement.onclick = () => selectChat({ type: 'group', id: group.id, name: group.name, members: group.members });
                    groupsList.appendChild(groupElement);
                });
            }
        }

        function selectChat(chatInfo) {
            activeChat = chatInfo;
            currentChatName.textContent = chatInfo.name;
            messagesDisplay.innerHTML = ''; // Clear previous messages
            initialChatMessage.classList.add('hidden'); // Hide initial message

            addMessageToDisplay(`You are now chatting in ${chatInfo.name}.`, myId, false, 'system');
            updateFriendListUI(); // Update UI to highlight selected chat
            updateGroupListUI();
        }

        function showModal(modalElement) {
            modalElement.classList.remove('hidden');
        }

        function hideModal(modalElement) {
            modalElement.classList.add('hidden');
        }

        // --- PeerJS Event Handlers ---
        function initializePeer() {
            peer = new Peer({
                config: {
                    iceServers: [
                        { urls: 'stun:stun.l.google.com:19302' },
                        { urls: 'stun:stun1.l.google.com:19302' },
                        { urls: 'stun:stun2.l.google.com:19302' },
                        { urls: 'stun:stun3.l.google.com:19302' },
                        { urls: 'stun:stun4.l.google.com:19302' }
                    ]
                }
            });

            peer.on('open', id => {
                myId = id;
                myPeerIdSpan.textContent = myId;
                console.log("My Peer ID:", myId);
            });

            peer.on('connection', (conn) => {
                console.log(`Incoming connection from ${conn.peer}`);
                addFriendStatus.textContent = `Incoming connection from ${conn.peer.substring(0, 5)}.`;
                addMessageToDisplay(`Incoming connection from ${conn.peer.substring(0, 5)}.`, conn.peer, false, 'system');

                if (!directConnections.has(conn.peer)) {
                    setupConnection(conn);
                    // Automatically add to friends list upon successful connection
                    if (!friends.some(f => f.id === conn.peer)) {
                        friends.push({ id: conn.peer, name: `Friend ${conn.peer.substring(0, 5)}` });
                        saveFriends();
                        updateFriendListUI();
                    }
                } else {
                    console.log(`Already connected to ${conn.peer}.`);
                    conn.on('open', () => conn.send('Already connected to you.'));
                    conn.close();
                }
            });

            peer.on('error', (err) => {
                console.error("PeerJS Error:", err);
                addFriendStatus.textContent = `Error: ${err.message}`;
                createGroupStatus.textContent = `Error: ${err.message}`;
            });
        }

        function setupConnection(conn) {
            directConnections.set(conn.peer, conn);

            conn.on('open', () => {
                console.log(`Connection opened with ${conn.peer}`);
                addFriendStatus.textContent = `Connected to ${conn.peer.substring(0, 5)}!`;
                addMessageToDisplay(`Connected to ${conn.peer.substring(0, 5)}.`, conn.peer, false, 'system');
                hideModal(addFriendModal);
                selectChat({ type: 'user', id: conn.peer, name: getFriendName(conn.peer) || conn.peer.substring(0, 5) });
            });

            conn.on('data', (data) => {
                console.log(`Received data from ${conn.peer}:`, data);
                try {
                    const parsedData = JSON.parse(data);
                    if (parsedData.type === 'group_message' && parsedData.groupId && parsedData.senderId) {
                        const targetGroup = groups.find(g => g.id === parsedData.groupId);
                        if (targetGroup && targetGroup.members.includes(myId)) {
                            if (activeChat.type === 'group' && activeChat.id === parsedData.groupId) {
                                addMessageToDisplay(parsedData.text, parsedData.senderId, false, 'group');
                            } else {
                                console.log(`New message in group ${targetGroup.name} from ${parsedData.senderId.substring(0, 5)}: ${parsedData.text}`);
                            }
                        }
                    } else {
                        // Direct message (could be string or non-group JSON)
                        if (activeChat.type === 'user' && activeChat.id === conn.peer) {
                            addMessageToDisplay(data, conn.peer, false, 'user');
                        } else {
                             console.log(`Direct message from non-active user ${conn.peer}: ${data}`);
                        }
                    }
                } catch (e) {
                    // Not JSON, treat as a regular direct message
                    if (activeChat.type === 'user' && activeChat.id === conn.peer) {
                        addMessageToDisplay(data, conn.peer, false, 'user');
                    } else {
                        console.log(`Direct message from non-active user ${conn.peer}: ${data}`);
                    }
                }
            });

            conn.on('close', () => {
                console.log(`Connection closed with ${conn.peer}`);
                addMessageToDisplay(`Disconnected from ${conn.peer.substring(0, 5)}.`, conn.peer, false, 'system');
                directConnections.delete(conn.peer);
                if (activeChat.id === conn.peer) {
                    activeChat = { type: null, id: null, name: null };
                    currentChatName.textContent = 'Select a chat';
                    messagesDisplay.innerHTML = '';
                    initialChatMessage.classList.remove('hidden');
                }
                updateFriendListUI();
            });

            conn.on('error', (err) => {
                console.error(`Connection error with ${conn.peer}:`, err);
                addFriendStatus.textContent = `Connection error with ${conn.peer.substring(0, 5)}.`;
                addMessageToDisplay(`Connection error with ${conn.peer.substring(0, 5)}.`, conn.peer, false, 'system');
                directConnections.delete(conn.peer);
                updateFriendListUI();
            });
        }

        // --- Event Listeners ---
        window.onload = initializePeer;

        myPeerIdSpan.addEventListener('click', () => {
            if (myId) {
                navigator.clipboard.writeText(myId).then(() => {
                    myPeerIdSpan.textContent = 'Copied!';
                    setTimeout(() => { myPeerIdSpan.textContent = myId; }, 1500);
                }).catch(err => {
                    console.error('Failed to copy ID:', err);
                    alert('Failed to copy ID. Please copy manually.');
                });
            }
        });

        // Add Friend Modal Logic (Now with optional name)
        addFriendSidebarBtn.addEventListener('click', () => {
            showModal(addFriendModal);
            friendIdInput.value = '';
            friendNameInput.value = ''; // Clear name input
            addFriendStatus.textContent = '';
        });

        cancelAddFriendBtn.addEventListener('click', () => {
            hideModal(addFriendModal);
            friendIdInput.value = '';
            friendNameInput.value = '';
            addFriendStatus.textContent = '';
        });

        confirmAddFriendBtn.addEventListener('click', () => {
            const friendId = friendIdInput.value.trim();
            const friendName = friendNameInput.value.trim();
            if (!friendId || friendId === myId) {
                addFriendStatus.textContent = 'Please enter a valid, different Peer ID.';
                return;
            }

            if (directConnections.has(friendId)) {
                addFriendStatus.textContent = `Already connected or attempting to connect to ${friendId.substring(0, 5)}.`;
                selectChat({ type: 'user', id: friendId, name: friendName || friendId.substring(0, 5) });
                hideModal(addFriendModal);
                return;
            }

            addFriendStatus.textContent = `Attempting to connect to ${friendId.substring(0, 5)}...`;
            const conn = peer.connect(friendId);
            setupConnection(conn);

            if (!friends.some(f => f.id === friendId)) {
                friends.push({ id: friendId, name: friendName || `Friend ${friendId.substring(0, 5)}` });
                saveFriends();
                updateFriendListUI();
            }
            friendIdInput.value = '';
            friendNameInput.value = '';
        });

        // Create Group Modal Logic
        createGroupBtn.addEventListener('click', () => {
            showModal(createGroupModal);
            groupNameInput.value = '';
            addMemberIdInput.value = '';
            selectedMembersList.innerHTML = '';
            createGroupStatus.textContent = '';
            if (myId) {
                const listItem = document.createElement('li');
                listItem.className = 'flex items-center justify-between p-2 bg-blue-100 rounded-md mb-1';
                listItem.textContent = `You (${myId.substring(0,5)})`;
                selectedMembersList.appendChild(listItem);
            }
            groupMembers.set('temp_group_members', new Set([myId]));
        });

        cancelCreateGroupBtn.addEventListener('click', () => {
            hideModal(createGroupModal);
            groupMembers.delete('temp_group_members');
        });

        addMemberBtn.addEventListener('click', () => {
            const memberId = addMemberIdInput.value.trim();
            if (!memberId || memberId === myId) {
                createGroupStatus.textContent = 'Enter a valid, different Peer ID to add.';
                return;
            }
            let tempMembers = groupMembers.get('temp_group_members') || new Set();
            if (tempMembers.has(memberId)) {
                createGroupStatus.textContent = 'This member is already added.';
                return;
            }
            tempMembers.add(memberId);
            groupMembers.set('temp_group_members', tempMembers);

            const listItem = document.createElement('li');
            listItem.className = 'flex items-center justify-between p-2 bg-gray-200 rounded-md mb-1';
            listItem.innerHTML = `
                <span>${getFriendName(memberId) || memberId.substring(0, 5)}</span>
                <button class="text-red-500 hover:text-red-700 text-sm remove-member-btn" data-id="${memberId}">Remove</button>
            `;
            selectedMembersList.appendChild(listItem);
            addMemberIdInput.value = '';
            createGroupStatus.textContent = '';

            listItem.querySelector('.remove-member-btn').addEventListener('click', (e) => {
                const idToRemove = e.target.dataset.id;
                let currentTempMembers = groupMembers.get('temp_group_members');
                if (currentTempMembers) {
                    currentTempMembers.delete(idToRemove);
                    groupMembers.set('temp_group_members', currentTempMembers);
                }
                listItem.remove();
            });
        });

        confirmCreateGroupBtn.addEventListener('click', () => {
            const groupName = groupNameInput.value.trim();
            const members = Array.from(groupMembers.get('temp_group_members') || []);

            if (!groupName) {
                createGroupStatus.textContent = 'Please enter a group name.';
                return;
            }
            if (members.length < 2) {
                createGroupStatus.textContent = 'Please add at least one other member to the group.';
                return;
            }

            const newGroupId = `group_${Date.now()}`;
            const newGroup = { id: newGroupId, name: groupName, members: members };
            groups.push(newGroup);
            saveGroups();
            updateGroupListUI();
            hideModal(createGroupModal);
            createGroupStatus.textContent = `Group "${groupName}" created!`;
            selectChat({ type: 'group', id: newGroupId, name: groupName, members: members });
        });


        // Send Message Logic
        sendMessageBtn.addEventListener('click', () => {
            const message = messageInput.value.trim();
            if (!message || !activeChat.id) return;

            addMessageToDisplay(message, myId, true, activeChat.type);
            messageInput.value = '';

            if (activeChat.type === 'user') {
                const conn = directConnections.get(activeChat.id);
                if (conn && conn.open) {
                    conn.send(message);
                } else {
                    addMessageToDisplay(`Error: Not connected to ${activeChat.name}.`, myId, false, 'system');
                    console.error('Connection not open for direct chat:', activeChat.id);
                }
            } else if (activeChat.type === 'group') {
                const group = groups.find(g => g.id === activeChat.id);
                if (group) {
                    const groupMessage = {
                        senderId: myId,
                        text: message,
                        type: 'group_message',
                        groupId: group.id
                    };
                    group.members.forEach(memberId => {
                        if (memberId !== myId) {
                            const conn = directConnections.get(memberId);
                            if (conn && conn.open) {
                                conn.send(JSON.stringify(groupMessage));
                            } else {
                                console.warn(`Could not send message to ${memberId.substring(0, 5)} in group ${group.name}: Not connected.`);
                            }
                        }
                    });
                }
            }
        });

        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessageBtn.click();
            }
        });

        // Theme Toggle
        themeToggleBtn.addEventListener('click', () => {
            const currentTheme = document.body.classList.contains('dark') ? 'dark' : 'light';
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            document.body.classList.remove(currentTheme);
            document.body.classList.add(newTheme);
            localStorage.setItem(LS_THEME_KEY, newTheme);
            themeToggleBtn.textContent = newTheme === 'light' ? '🌙' : '☀️';
        });

        // Initial theme load
        const savedTheme = localStorage.getItem(LS_THEME_KEY) || 'light';
        document.body.classList.add(savedTheme);
        themeToggleBtn.textContent = savedTheme === 'light' ? '🌙' : '☀️';

        // Initial UI updates
        updateFriendListUI();
        updateGroupListUI();

        // Search functionality (basic client-side filter)
        searchInput.addEventListener('input', () => {
            const searchTerm = searchInput.value.toLowerCase();

            directMessagesList.querySelectorAll('.flex.items-center').forEach(item => {
                const name = item.querySelector('.font-semibold').textContent.toLowerCase();
                if (name.includes(searchTerm)) {
                    item.classList.remove('hidden');
                } else {
                    item.classList.add('hidden');
                }
            });

            groupsList.querySelectorAll('.flex.items-center').forEach(item => {
                const name = item.querySelector('.font-semibold').textContent.toLowerCase();
                if (name.includes(searchTerm)) {
                    item.classList.remove('hidden');
                } else {
                    item.classList.add('hidden');
                }
            });
        });
    </script>
</body>
</html>
